<?xml version="1.0" standalone="no"?>

<kickstart>

        <description>
        Opal (Java)
        Frontend stuffs. Create the user and set the share for opal
        </description>

        <copyright>
        Copyright (c) 2000 - 2008 The Regents of the University of California.
        All rights reserved.
        </copyright>

        <changelog>
        </changelog>


<post os="linux" arch="x86_64">

LOGFILE=/tmp/opal-install.log


<!--       setting up tomcat -->

<!-- add tomcat user -->
/bin/mkdir -p /export/home
/usr/sbin/useradd -m -c "Tomcat" tomcat
chown -R tomcat.tomcat /opt/tomcat
chown -R tomcat.tomcat /opt/tomcat-*
<file name="/tmp/create-sshkey.sh" perm="0755">
#no password prompt
mkdir /export/home/tomcat/.ssh
ssh-keygen -t rsa -f /export/home/tomcat/.ssh/id_rsa -v -N "" -q


# Copy public key to authorized_keys file.
cat /export/home/tomcat/.ssh/id_rsa.pub >> /export/home/tomcat/.ssh/authorized_keys

chmod 600 /export/home/tomcat/.ssh/authorized_keys
chmod 700 /export/home/tomcat/.ssh
chmod g-w /export/home/tomcat
</file>

/opt/rocks/bin/rocks sync users
#set up shared keys
/usr/bin/sudo -u tomcat bash /tmp/create-sshkey.sh
rm /tmp/create-sshkey.sh

<!-- Make NFS shared directory for opal jobs -->
mkdir -m0755 -p /export/opal/opal-jobs 
chown -R tomcat:tomcat /export/opal
<file name="/etc/auto.share" mode="append">
opal &Kickstart_PrivateHostname;:/export/&amp;
</file>




<!-- add cron entry to remove old jobs -->

<file name="/etc/cron.daily/opal-job-cleanup" perms="0755">
#!/bin/bash

# Removes old opal job directories older then default days

# default number of days to keep job direcotry 
n=21

cd /export/opal/opal-jobs
dirs=`find . -type d -name 'app*' -mtime +$n -print`
for i in $dirs
do
    rm -rf $i
done
</file>

<!--    define a opal appliance    -->
/opt/rocks/bin/rocks add appliance opal-server membership="Opal Server" public=yes os=linux node=login
/opt/rocks/bin/rocks add appliance attr opal-server attr=opal_server value=true

/opt/rocks/bin/rocks add host attr localhost  attr=opal_server value=true
/opt/rocks/bin/rocks set appliance attr opal_server submit_host true
/opt/rocks/bin/rocks set appliance attr opal_server exec_host false

</post>

</kickstart>
